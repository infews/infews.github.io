<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Synology on Rails Part IV: Simplifying Deploys | DWF’s Journal</title> <link href='/feed.xml' rel=alternate title='Atom Feed' type='application/atom+xml'> <script type='application/ld+json'>
{"@type":"BlogPosting","url":"https://dwf.bigpencil.net/synology-using-docker-compose/","datePublished":"2024-05-01","dateCreated":"2024-05-01","dateModified":"2024-04-29","headline":"Synology on Rails Part IV: Simplifying Deploys","abstract":"Moving an app to Synology Container Manager Projects, which uses Docker Compose, is a huge improvement.","keywords":["web development","ruby","rails","software engineering","deployment","docker","containers","synology","nas"],"author":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"publisher":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"articleBody":"\nNow that we have a local container registry running on the Synology NAS, how do we use it? We want to push updated containerized app builds to this registry, as well as set up the Synology Container Manager for low-fuss deploys.\n\nPushing to the Registry\n\nPushing is simple. Following the Docker instructions, there are two small steps - first is tagging the image with the registry URL. Then pushing the new tagged image:\n\n$ docker tag dwfrank/meals registry.local/dwfrank/meals\n$ docker push registry.local/dwfrank/meals\n\n\nRecall from the previous post that I have local DNS set up for registry.local. If you’re following along and don’t have the ability to use local DNS, an IP address + port will work.\n\nTo verify that the push worked, I did the following:\n\n\n  Go to the Container Manager / Registry pane\n  Click the Settings button and to see my local registry in the list\n  Click the local registry row and then click the Use button; it now had a green checkmark\n  Close this dialog\n\n\nAnd there was dwfrank/meals in the local registry. Boom.\n\nMoving to Docker Compose\n\nIn earlier exploration, I had some problems using docker-compose.yml to configure my app. But since I got the Container Registry working, I understand Synology’s terminology better. And it turns out that using a Container Manager Project w/ a docker-compose.yml makes updates very simple.\n\n1. Delete the Old Versions of the app\n\nI deleted the current image, container (both of these in Container Manager), and the app’s Web Portal (in WebStation).I’m not going to be using them any more.\n\n2. Make the docker-compose File\n\nNext I made a docker-compose.yml file in my app’s root directory (so it was in git):\n\nversion: \"3.5\"  \nservices:  \n  web:  \n    image: registry.local/dwfrank/meals  \n    container_name: balboa-meals\n    network_mode: bridge  \n    volumes:  \n      - /volume1/docker/meals/db:/rails/storage  \n    ports:  \n      - 3000:3000  \n    command: bash -c \"rm -f tmp/pids/server.pid \u0026amp;\u0026amp; ./bin/rails server\"\n\n\nAnd then I copied this to the app’s NAS directory at /Volumes/docker/meals on my desktop, where it’s mounted from /volume1/docker/meals.\n\n3. Create a Container Manager project\n\nAgain, just like the registry, I created a new Container Manager Project and pointed it at /volume1/docker/meals. It found the docker-compose.yml, then downloaded the image from the local registry, made the container, and then launched WebStation’s “create a Web Portal” dialog.\n\nI gave it the local URL as a name as before. And the app came right up.\n\nDeploying to Tie It All Together\n\nThe full deploy cycle is now very simple.\n\nFrom my desktop (using my deploy tasks linked above):\n\n$ bundle exec update_version deploy\n\nThen on the Synology1:\n\n\n  Go to the Container Manager / Registry pane\n  Double click on the image I want to update\n    \n      From the dialog, choose the “latest” tag and hit Apply; this downloads the updated image\n      Wait for the download to complete\n    \n  \n  Container Manager / Project Pane\n    \n      Click the Project\n      From the Actions button, choose Stop; wait for the dialog to say it’s complete\n      From the Actions button, choose Build; wait for the dialog to say it’s complete\n    \n  \n\n\nAnd that’s it. Far less clunky and error prone. And all of the configuration, thanks to the docker-compose.yml file is in source control.\n\nIn case it helps your projects, I’ve extracted my deploy tasks to this repo on GitHub for easy inclusion in other Rails apps. These are not Synology-specific, and tie together all the knowledge from this series.\n\n\n  \n    \n      This guide (Internet Archive version) has a good step-by-step. However, Container Manager doesn’t show which projects have images with updates in the local registry. But that’s not bothering me for now. \u0026#8617;\n    \n  \n\n","@context":"https://schema.org"}
</script> <link href='https://cdn.jsdelivr.net/npm/holiday.css@0.11.2' rel=stylesheet> <script crossorigin=anonymous src='https://kit.fontawesome.com/e76ee0328c.js'></script> <link href='/stylesheets/v23-fb3ac88f.css' rel=stylesheet> <link href='/stylesheets/prism-laserwave-b0c76a64.css' rel=stylesheet> <script src='/js/prism-7933fd4a.js'></script> </head> <body> <nav class=menu> <ul> <li> <a class='' href='/'>Home</a> </li> <li> <span>Posts</span> <ul> <li> <a href='/series/the-cd-test'>The CD Test</a> </li> <li> <a href='/series/obsidian'>How I Obsidian</a> </li> <li> <a href='/series/interestings'>Interestings for Iterators</a> </li> <li> <a href='/series/rails-docker-nas'>Synology on Rails</a> </li> <li> <a href='/posts'>All Posts</a> </li> <li> <a href='/all_tags'>All Tags</a> </li> </ul> </li> <li> <a href='/about_me'>About Me</a> </li> </ul> </nav> <main class=''> <article> <h1> Synology on Rails Part IV: Simplifying Deploys </h1> <section class='header with_sharing'> <div class=info> <span class=date> 1 May 2024</span> <span class=dash>&#8212;</span> <span class=duration>about a 3 minute read</span> </div> <div class=sharing> <button article='Synology on Rails Part IV: Simplifying Deploys' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> <section class=text> <p>Now that we have a local container registry running on the Synology NAS, how do we use it? We want to push updated containerized app builds to this registry, as well as set up the Synology Container Manager for low-fuss deploys.</p> <h2>Pushing to the Registry</h2> <p>Pushing is simple. Following the Docker instructions, there are two small steps - first is tagging the image with the registry URL. Then pushing the new tagged image:</p> <pre><code class="language-shell">$ docker tag dwfrank/meals registry.local/dwfrank/meals
$ docker push registry.local/dwfrank/meals
</code></pre> <p>Recall from the <a href="/synology-with-registry/">previous post</a> that I have local DNS set up for <code>registry.local</code>. If you’re following along and don’t have the ability to use local DNS, an IP address + port will work.</p> <p>To verify that the push worked, I did the following:</p> <ol> <li>Go to the Container Manager / Registry pane</li> <li>Click the Settings button and to see my local registry in the list</li> <li>Click the local registry row and then click the Use button; it now had a green checkmark</li> <li>Close this dialog</li> </ol> <p>And there was <code>dwfrank/meals</code> in the local registry. Boom.</p> <h2>Moving to Docker Compose</h2> <p>In earlier exploration, I had some problems using <code>docker-compose.yml</code> to configure my app. But since I got the Container Registry working, I understand Synology’s terminology better. And it turns out that using a Container Manager Project w/ a <code>docker-compose.yml</code> makes updates <em>very</em> simple.</p> <h3>1. Delete the Old Versions of the app</h3> <p>I deleted the current image, container (both of these in Container Manager), and the app’s Web Portal (in WebStation).I’m not going to be using them any more.</p> <h3>2. Make the docker-compose File</h3> <p>Next I made a <code>docker-compose.yml</code> file in my app’s root directory (so it was in <code>git</code>):</p> <pre><code class="language-yaml">version: "3.5"  
services:  
  web:  
    image: registry.local/dwfrank/meals  
    container_name: balboa-meals
    network_mode: bridge  
    volumes:  
      - /volume1/docker/meals/db:/rails/storage  
    ports:  
      - 3000:3000  
    command: bash -c "rm -f tmp/pids/server.pid &amp;&amp; ./bin/rails server"
</code></pre> <p>And then I copied this to the app’s NAS directory at <code>/Volumes/docker/meals</code> on my desktop, where it’s mounted from <code>/volume1/docker/meals</code>.</p> <h3>3. Create a Container Manager project</h3> <p>Again, just like the registry, I created a new Container Manager Project and pointed it at <code>/volume1/docker/meals</code>. It found the <code>docker-compose.yml</code>, then downloaded the image from the local registry, made the container, and then launched WebStation’s “create a Web Portal” dialog.</p> <p>I gave it the local URL as a name as before. And the app came right up.</p> <h2>Deploying to Tie It All Together</h2> <p>The full deploy cycle is now <em>very</em> simple.</p> <p>From my desktop (using my deploy tasks linked above):</p> <p><code>$ bundle exec update_version deploy</code></p> <p>Then on the Synology<sup id="fnref:1" role=doc-noteref><a href="#fn:1" class=footnote rel=footnote>1</a></sup>:</p> <ol> <li>Go to the Container Manager / Registry pane</li> <li>Double click on the image I want to update <ol> <li>From the dialog, choose the “latest” tag and hit Apply; this downloads the updated image</li> <li>Wait for the download to complete</li> </ol> </li> <li>Container Manager / Project Pane <ol> <li>Click the Project</li> <li>From the Actions button, choose Stop; wait for the dialog to say it’s complete</li> <li>From the Actions button, choose Build; wait for the dialog to say it’s complete</li> </ol> </li> </ol> <p>And that’s it. Far less clunky and error prone. And all of the configuration, thanks to the <code>docker-compose.yml</code> file is in source control.</p> <p>In case it helps your projects, I’ve extracted my <a href="https://github.com/infews/synology_rails_deploy_tasks">deploy tasks to this repo on GitHub</a> for easy inclusion in other Rails apps. These are not Synology-specific, and tie together all the knowledge from this series.</p> <div class=footnotes role=doc-endnotes> <ol> <li id="fn:1" role=doc-endnote> <p>This <a href="https://web.archive.org/web/20240209012226/https://mariushosting.com/synology-how-to-update-containers-in-container-manager/">guide</a> (Internet Archive version) has a good step-by-step. However, Container Manager doesn’t show which projects have images with updates in the local registry. But that’s not bothering me for now. <a href="#fnref:1" class=reversefootnote role=doc-backlink>&#8617;</a></p> </li> </ol> </div> </section> <hr> <section class='about with_sharing'> <div class=tags> This article is part of the series <a href="/series/rails-docker-nas">Synology on Rails</a> and is tagged with <a href="/tags/web-development">web development</a>, <a href="/tags/ruby">ruby</a>, <a href="/tags/rails">rails</a>, <a href="/tags/software-engineering">software engineering</a>, and <a href="/tags/deployment">deployment</a>. </div> <div class=sharing> <button article='Synology on Rails Part IV: Simplifying Deploys' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> </article> </main> <footer class=site> <p class=small>© 2024 Davis W. Frank</p> </footer> <script async='' src='https://www.googletagmanager.com/gtag/js?id=G-SNXCW3490N'></script> <script>
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
gtag('config', 'G-SNXCW3490N');
</script> </body> <script src='/js/share-c97280fa.js'></script> </html>
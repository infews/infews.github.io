<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Synology on Rails Part III: Improve Deploying with a Local Registry | DWF’s Journal</title> <link href='/feed.xml' rel=alternate title='Atom Feed' type='application/atom+xml'> <script type='application/ld+json'>
{"@type":"BlogPosting","url":"https://dwf.bigpencil.net/synology-with-registry/","datePublished":"2024-04-28","dateCreated":"2024-04-28","dateModified":"2024-09-25","headline":"Synology on Rails Part III: Improve Deploying with a Local Registry","abstract":"Manual deploy steps are maddening. Let's fix it.","keywords":["web development","ruby","rails","software engineering","deployment","docker","containers","synology","nas"],"author":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"publisher":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"articleBody":"\n2024.09.25 UPDATE\n\nThis article is superseded by Part VI, which starts up a registry and UI for that registry. This article is mostly useful for context.\n\nWell, my app is deployed and running. But after several months of continued development and maintenance, I’m not happy with how I deploy this app. The required manual steps in the Synology DSM UI have proven error prone. I often forget what the steps are and have to click around until it’s working. How might we improve deploying my containerized Rails app?\n\nAfter talking to others and researching some more, I have two things to try in order to make deploying a container image to my Synology NAS.\n\nA Local Registry\n\nIf you recall the previous posts, getting the image from my desktop to the NAS has these steps:\n\n\n  Export the image from Docker into a tarfile\n  Copy the tarfile to the NAS via the Terminal\n  Delete the tarfile.\n\n\nThat has always felt clunky.\n\nI’m not the only one that thinks there’s no need to copy a 500GB image up to the Internet, only to copy it back down again. There’s consensus around running a local container registry, in a container, on the Synology NAS. Why not? This would drop the export and delete steps from my current workflow. And is makes more sense when deploying via containers.\n\nGood news, everyone! This is super easy. Docker Hub hosts a registry image that nearly drops right in.\n\n1. Make a new shared directory\n\nI made a new directory on the NAS at  /volume1/docker/registry. I used this folder because I’m already sharing /volume1/docker to my network. All my deployable apps have their mount points there. On my Mac, this mounts as /Volumes/docker.\n\n2. Make a new docker-compose file\n\nOn my desktop I created this file: /Volumes/docker/registry/docker-compose.yml - and filled it with this:\n\nversion: \"3.5\"\nservices:\n  registry:\n    image: registry\n    container_name: registry\n    network_mode: bridge\n    volumes:\n      # map your volume on the left as makes sense for you\n      - /volume1/docker/registry/:/var/lib/registry\n    ports:\n      # important b/c Synology runs DSM on port 5000\n      - 5050:5000\n    restart: unless-stopped\n\n\nThe first key thing here is to map the volumes correctly - the left-hand size of the colon needs to be the Synology path to the directory I created in the first step. The Docker registry will see this at its /var/lib/registry and create files there.\n\nThe second is that I needed to map the port. The registry container is listening on 5000. But Synology uses 5000 for the DSM web interface. So I chose 5050, which does not conflict.\n\n3. Create the Container Manager Project\n\nIn Container Manger, I made a new Project. I called it “registry”. I used the path from first step. Container Manager found the docker-compose.yml and asked to use it.\n\nIt downloaded the registry image from Docker Hub, created the container, and started it. Container Manager calls this “building” the project.\n\nI got a Container Manager dialog that had a checkbox to “allow insecure registry.” I said yes. I’m not opening this registry to the Internet, so I’m fine with this.\n\n4. Create the Web Portal\n\nNext, Container Manager brings up the Web Station the dialog for creating the Web Portal for the registry. I gave this a domain name of registry.local.\n\nI am able to create custom DNS “records” on my home firewall/router (shout out to Firewalla), so I set registry.local to map to my Synology NAS’s IP address - which is a reserved address in my DHCP server.\n\n5. Run and Test\n\nThen I visited http://registry.local/v2/ and got a response of {}. So, yay! A registry!\n\nNext up is using this registry at deploy time.\n","@context":"https://schema.org"}
</script> <link href='https://cdn.jsdelivr.net/npm/holiday.css@0.11.2' rel=stylesheet> <script crossorigin=anonymous src='https://kit.fontawesome.com/e76ee0328c.js'></script> <link href='/stylesheets/v23-fb3ac88f.css' rel=stylesheet> <link href='/stylesheets/prism-laserwave-b0c76a64.css' rel=stylesheet> <script src='/js/prism-7933fd4a.js'></script> </head> <body> <nav class=menu> <ul> <li> <a class='' href='/'>Home</a> </li> <li> <span>Posts</span> <ul> <li> <a href='/series/the-cd-test'>The CD Test</a> </li> <li> <a href='/series/obsidian'>How I Obsidian</a> </li> <li> <a href='/series/interestings'>Interestings for Iterators</a> </li> <li> <a href='/series/rails-docker-nas'>Synology on Rails</a> </li> <li> <a href='/posts'>All Posts</a> </li> <li> <a href='/all_tags'>All Tags</a> </li> </ul> </li> <li> <a href='/about_me'>About Me</a> </li> </ul> </nav> <main class=''> <article> <h1> Synology on Rails Part III: Improve Deploying with a Local Registry </h1> <section class='header with_sharing'> <div class=info> <span class=date>28 April 2024</span> <span class=dash>&#8212;</span> <span class=duration>about a 3 minute read</span> </div> <div class=sharing> <button article='Synology on Rails Part III: Improve Deploying with a Local Registry' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> <section class=text> <h3>2024.09.25 UPDATE</h3> <p><em><strong>This article is superseded by <a href="/synology-improved-registry/">Part VI</a>, which starts up a registry and UI for that registry. This article is mostly useful for context.</strong></em></p> <p>Well, my app is deployed and running. But after several months of continued development and maintenance, I’m not happy with how I deploy this app. The required manual steps in the Synology DSM UI have proven error prone. I often forget what the steps are and have to click around until it’s working. How might we improve deploying my containerized Rails app?</p> <p>After talking to others and researching some more, I have two things to try in order to make deploying a container image to my Synology NAS.</p> <h2>A Local Registry</h2> <p>If you recall the <a href="/rails-containers-on-synology/">previous</a> <a href="/deploying-containers-synology/">posts</a>, getting the image from my desktop to the NAS has these steps:</p> <ul> <li>Export the image from Docker into a tarfile</li> <li>Copy the tarfile to the NAS via the Terminal</li> <li>Delete the tarfile.</li> </ul> <p>That has always felt clunky.</p> <p>I’m not the only one that thinks there’s no need to copy a 500GB image up to the Internet, only to copy it back down again. There’s consensus around running a local container registry, in a container, on the Synology NAS. Why not? This would drop the export and delete steps from my current workflow. And is makes more sense when deploying via containers.</p> <p>Good news, everyone! This is super easy. Docker Hub hosts a registry image that nearly drops right in.</p> <h3>1. Make a new shared directory</h3> <p>I made a new directory on the NAS at <code>/volume1/docker/registry</code>. I used this folder because I’m already sharing <code>/volume1/docker</code> to my network. All my deployable apps have their mount points there. On my Mac, this mounts as <code>/Volumes/docker</code>.</p> <h3>2. Make a new docker-compose file</h3> <p>On my desktop I created this file: <code>/Volumes/docker/registry/docker-compose.yml</code> - and filled it with this:</p> <pre><code class="language-yaml">version: "3.5"
services:
  registry:
    image: registry
    container_name: registry
    network_mode: bridge
    volumes:
      # map your volume on the left as makes sense for you
      - /volume1/docker/registry/:/var/lib/registry
    ports:
      # important b/c Synology runs DSM on port 5000
      - 5050:5000
    restart: unless-stopped
</code></pre> <p>The first key thing here is to map the volumes correctly - the left-hand size of the colon needs to be the Synology path to the directory I created in the first step. The Docker registry will see this at its <code>/var/lib/registry</code> and create files there.</p> <p>The second is that I needed to map the port. The registry container is listening on 5000. But Synology uses 5000 for the DSM web interface. So I chose 5050, which does not conflict.</p> <h3>3. Create the Container Manager Project</h3> <p>In Container Manger, I made a new Project. I called it “registry”. I used the path from first step. Container Manager found the <code>docker-compose.yml</code> and asked to use it.</p> <p>It downloaded the registry image from Docker Hub, created the container, and started it. Container Manager calls this “building” the project.</p> <p>I got a Container Manager dialog that had a checkbox to “allow insecure registry.” I said yes. I’m not opening this registry to the Internet, so I’m fine with this.</p> <h3>4. Create the Web Portal</h3> <p>Next, Container Manager brings up the Web Station the dialog for creating the Web Portal for the registry. I gave this a domain name of <code>registry.local</code>.</p> <p>I am able to create custom DNS “records” on my home firewall/router (shout out to <a href="https://www.firewalla.com">Firewalla</a>), so I set <code>registry.local</code> to map to my Synology NAS’s IP address - which is a reserved address in my DHCP server.</p> <h3>5. Run and Test</h3> <p>Then I visited <code>http://registry.local/v2/</code> and got a response of <code>{}</code>. So, yay! A registry!</p> <p>Next up is using this registry at deploy time.</p> </section> <hr> <section class='about with_sharing'> <div class=tags> This article is part of the series <a href="/series/rails-docker-nas">Synology on Rails</a> and is tagged with <a href="/tags/web-development">web development</a>, <a href="/tags/ruby">ruby</a>, <a href="/tags/rails">rails</a>, <a href="/tags/software-engineering">software engineering</a>, and <a href="/tags/deployment">deployment</a>. </div> <div class=sharing> <button article='Synology on Rails Part III: Improve Deploying with a Local Registry' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> </article> </main> <footer class=site> <p class=small>© 2025 Davis W. Frank</p> </footer> <script async='' src='https://www.googletagmanager.com/gtag/js?id=G-SNXCW3490N'></script> <script>
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
gtag('config', 'G-SNXCW3490N');
</script> </body> <script src='/js/share-c97280fa.js'></script> </html>
<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Synology on Rails Part II: Deploying | DWF’s Journal</title> <link href='/feed.xml' rel=alternate title='Atom Feed' type='application/atom+xml'> <script type='application/ld+json'>
{"@type":"BlogPosting","url":"https://dwf.bigpencil.net/deploying-containers-synology/","datePublished":"2023-12-15","dateCreated":"2023-12-15","dateModified":"2023-12-15","headline":"Synology on Rails Part II: Deploying","abstract":"Digging deep in the terminal and figuring out how to use rake to deploy my containerized Rails app to my Synology NAS.","keywords":["web development","ruby","rails","software engineering","deployment","docker","containers","synology","nas"],"author":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"publisher":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"articleBody":"\nThis is part II. Visit rest of this series to find out how we got here.\n\nNow that I had a very manual set of steps to get my Meal Planning app to run on Synology DSM, I wanted a more automated set of deployment steps - something I could deploy with a single rake task.\n\nWhat I Wanted\n\n\n  No DockerHub round tripping\n    \n      Why send 1GB up to the cloud just to come back down again?\n    \n  \n  Local image building\n    \n      MacOS/M2 build times were under 3 minutes vs. over 20+ minutes on the NAS\n    \n  \n  One rake task to do it all from clean git to new version of the app up and running\n\n\nWhat I Had\n\n\n  Only a partial understanding of how the Synology GUI maps to Docker underneath\n  Zero clue if this was possible\n\n\nWhat I Did\n\nLet’s see what happened.\n\nTL;DR Here’s a repo of the final files.\n\n1. Get the Image to the NAS\n\nOnce I made the decision to not involve Docker Hub, or any registry, I figured this was going to be simple enough copy across my network, right? I had a folder on the NAS that was accessible.\n\nI just needed to save the image out to a .tar file and then copy it to the server.\n\n$ docker save dwfrank/meals \u0026gt; tmp/dwfrank-meals.tar\n$ cp tmp/dwfrank-meals.tar /Volumes/docker/meals\n\n\nThere are two key things here:\n\n\n  I used docker save to get the built image from local Docker. Export also worked, but caused problems later.\n  I saved the tar file in ./tmp, which is in the .dockerignore file, which means it’s in the development file system, but not the container image.\n\n\n2. Get the Container Loaded\n\nThe Synology Container Manager GUI will let you import an image in a tar file. That way was easy. But how could I do this from the command line?\n\nI learned two things:\n\n\n  The Container Manager GUI is really just running docker under the hood.\n  The docker and docker-compose executables are installed, but only for root or sudo access.\n\n\nI enabled the Synology’s SSH service, on an alternate port, and made sure my NAS’s deploy user had administrator rights. Then I set up a key pair so I could ssh without a password.\n\nAfter some trial and error, I found that I needed to use Docker’s load command:\n\n$ sudo docker load --input /volume1/docker/meals/dwfrank-meals.tar\n\n\n…and that I had to have the full path to the image.1\n\nThe image showed up in Container Manager as expected. Progress!\n\n3. Injecting Values into the Dockerfile\n\nI decided that the most appropriate place to add the RAILS_MASTER_KEY environment variable was when the image is built. It keeps all the environment vars together, after all.\n\nSo back to the Dockerfile and its env vars section:\n\nARG MASTER_KEY=\"\"  \n  \n# Set production environment  \nENV RAILS_ENV=\"production\" \\  \n    BUNDLE_DEPLOYMENT=\"1\" \\  \n    BUNDLE_PATH=\"/usr/local/bundle\" \\  \n    BUNDLE_WITHOUT=\"development\" \\  \n    RAILS_MASTER_KEY=$MASTER_KEY\n\n\nI added the empty Docker ARG for the master key, and then pass it in at build time.2 This meant writing the first rake task that does any of this work so I could read the key from the Rails config directory:\n\nkey = File.read(\"config/master.key\")  \nsystem \"docker buildx build --build-arg=\\\"MASTER_KEY=#{key}\\\" --platform linux/amd64 -t dwfrank/meals .\"\n\n\nI round-tripped the build again, and after running sudo docker load, the RAILS_MASTER_KEY was right there with the rest of the variables.\n\n4. Adding the Database Volume Mount Point\n\nIt looked like docker-compose was the right way to add volumes. So I  created a docker-compose.yml in my app’s root with the image name, the name for the container when it’s running, and the database mount point:\n\nservices:  \n  web:  \n    image: dwfrank/meals  \n    container_name: balboa-meals  \n    command: bash -c \"rm -f tmp/pids/server.pid \u0026amp;\u0026amp; ./bin/rails server\"  \n    volumes:  \n      - /volume1/docker/meals/db:/rails/db/production\n\n\nThen I copied this file to the NAS, ssh’d over, and then called docker-compse:\n\n$ cp docker-compose.yml /Volumes/docker/meals\n$ ssh deploy@192.168.1.100:822\n$ # Now on the NAS\n$ cd /volume1/docker/meals\n$ sudo docker-compose create .\n\n\n…and I had the container loaded but not running. And all of the environment variables were there as I expected.\n\n5. Connecting the Container to the Web Station\n\nThe last step was going to have to be manual for now. In the DSM GUI:3\n\n\n  Container Manager - run the container\n  Web Station - reconnect the meals.local portal, which won’t have a container associated with it, to the container I just ran.\n\n\nSo let’s stitch this all together!\n\n6. Rake All the Things!\n\nTo recap the work so far, I did the following:\n\n\n  Built a production.sqlite3\n    \n      Moved to a subdirectory under ./db\n      Fixed ./config/database.yml\n    \n  \n  Added a ./.dockerignore\n    \n      Excluded ./tmp\n      Excluded ./db/production/\n    \n  \n  Updated the Rails ./Dockerfile\n    \n      Commented out asset builds\n      Added NAS user and group IDs to the chown commands\n      Added injecting the RAILS_MASTER_KEY during the image build\n      Used this Dockerfile to build the container image from the command line\n    \n  \n  Added a ./docker-compose.yml\n    \n      Picks the image name\n      Sets a container name\n      Sets the database volume mount point\n    \n  \n\n\nThe remaining work that needed to be done on the NAS, via sudo, to deploy the app was to load the image, with docker, and then execute docker-compose. Local commands are easy. But what about the sudo commands?\n\nEnter SSHKit. This is what Capistrano and Kamal use under the hood in order to do their work. And SSHKit has a Sudo module. So I was able to use all this for the last remote commands.\n\nI made two additions to the Gemfile development group:\n\ngem \"sshkit\"  \ngem \"sshkit-sudo\"\n\n\nAnd then these commands are in a Rake task:\n\nrequire \"sshkit\"\nrequire \"sshkit/dsl\"\nrequire \"sshkit/sudo\"\n\ndesc \"Loads the built image into Docker on Filgate\"  \ntask :deploy_to_synology do\n include SSHKit::DSL\n\n  pw = \"kwijibo\" # get your password from a password manager, etc.\n  send_password = SSHKit::MappingInteractionHandler.new(\"Password: \" =\u0026gt; pw)\n\n  bin = \"/usr/local/bin\"\n  docker_compose = \"#{bin}/docker-compose\"\n  docker = \"#{bin}/docker\"\n\n  on \"deployuser@192.168.10.124:622\" do\n    # acutal mounted path for the docker folder\n    within \"/volume1/docker/meals\" do\n      sudo \"#{docker_compose} down\",\n        interaction_handler: send_password\n      sudo \"#{docker} image rm --force dwfrank/meals\",\n        interaction_handler: send_password\n      sudo \"#{docker} load --input /volume1/docker/meals/dwfrank-meals.tar\",\n        interaction_handler: send_password\n      sudo \"#{docker_compose} create\",\n        interaction_handler: send_password\n    end\n  end\nend\n\n\nOf note above:\n\n  SSHKit wasn’t loading the PATH as expected, so I used absolute paths to the executables\n  It stops the running container down and then deletes its image\n  Then it uses docker load to add the image to Container Manager/Docker\n    \n      The assumption is that the image tar is present\n    \n  \n  Then it uses docker-compose to create the new container from that image\n\n\nSo when you look at the repo, you’ll see these tasks:\n\n\n  Ensure that git is clean and everything is committed.\n  Rebuild the Rails assets in ./public.\n  Build the image.\n  Copy the image and docker-compose.yml to the NAS.\n  Do the Docker work on the NAS:\n    \n      Top the current container\n      Remove its image\n      Load the new image\n      Create the new container\n    \n  \n\n\nPhew! And now I’m wondering how I can get the last manual steps into Rake tasks. Stay Tuned!\n\n\n\n  \n    \n      My Synology NAS mounts most of the file system to /volume1. Your mileage will vary and will be different from what you see in the DSM File Station. \u0026#8617;\n    \n    \n      I also went back and uses the same technique for the UserID and GroupID for the chown command. You can see that in the code in the GIST. \u0026#8617;\n    \n    \n      I’m guessing that Web Station sits on top nginx configuration files, but I’ve not found them or the right mix of commands yet. I will update this post, and/or add a Part III, once I figure this out. \u0026#8617;\n    \n  \n\n","@context":"https://schema.org"}
</script> <link href='https://cdn.jsdelivr.net/npm/holiday.css@0.11.2' rel=stylesheet> <script crossorigin=anonymous src='https://kit.fontawesome.com/e76ee0328c.js'></script> <link href='/stylesheets/v23-87c5bb67.css' rel=stylesheet> <link href='/stylesheets/prism-laserwave-b0c76a64.css' rel=stylesheet> <script src='/js/prism-7933fd4a.js'></script> </head> <body> <nav class=menu> <ul> <li> <a class='' href='/'>Home</a> </li> <li> <span>Posts</span> <ul> <li> <a href='/series/the-cd-test'>The CD Test</a> </li> <li> <a href='/series/obsidian'>How I Obsidian</a> </li> <li> <a href='/series/rails-docker-nas'>Synology on Rails</a> </li> <li> <a href='/posts'>All Posts</a> </li> <li> <a href='/all_tags'>All Tags</a> </li> </ul> </li> <li> <a href='/notion'>Notion Templates</a> </li> <li> <a href='/about_me'>About Me</a> </li> </ul> </nav> <main class=''> <article> <h1> Synology on Rails Part II: Deploying </h1> <section class='header with_sharing'> <div class=info> <span class=date>15 December 2023</span> <span class=dash>&#8212;</span> <span class=duration>about a 7 minute read</span> </div> <div class=sharing> <button article='Synology on Rails Part II: Deploying' class=share style='display: none;' type=button> Share <i class='fa-solid fa-arrow-up-right-from-square'></i> </button> </div> </section> <section class=text> <p><em>This is part II. Visit <a href="/series/rails-docker-nas">rest of this series</a> to find out how we got here.</em></p> <p>Now that I had a <em>very</em> <a href="/rails-containers-on-synology/">manual set of steps</a> to get my Meal Planning app to run on Synology DSM, I wanted a more automated set of deployment steps - something I could deploy with a single rake task.</p> <h2>What I Wanted</h2> <ul> <li>No DockerHub round tripping <ul> <li>Why send 1GB up to the cloud just to come back down again?</li> </ul> </li> <li>Local image building <ul> <li>MacOS/M2 build times were under 3 minutes vs. over 20+ minutes on the NAS</li> </ul> </li> <li>One rake task to do it all from clean git to new version of the app up and running</li> </ul> <h2>What I Had</h2> <ul> <li>Only a partial understanding of how the Synology GUI maps to Docker underneath</li> <li>Zero clue if this was possible</li> </ul> <h2>What I Did</h2> <p>Let’s see what happened.</p> <p><strong>TL;DR</strong> Here’s <a href="https://github.com/infews/synology_on_rails">a repo of the final files</a>.</p> <h3>1. Get the Image to the NAS</h3> <p>Once I made the decision to not involve Docker Hub, or any registry, I figured this was going to be simple enough copy across my network, right? I had a folder on the NAS that was accessible.</p> <p>I just needed to save the image out to a .tar file and then copy it to the server.</p> <pre><code class="language-sh">$ docker save dwfrank/meals &gt; tmp/dwfrank-meals.tar
$ cp tmp/dwfrank-meals.tar /Volumes/docker/meals
</code></pre> <p>There are two key things here:</p> <ol> <li>I used <code>docker save</code> to get the built image from local Docker. Export also worked, but caused problems later.</li> <li>I saved the tar file in <code>./tmp</code>, which is in the <code>.dockerignore</code> file, which means it’s in the development file system, but not the container image.</li> </ol> <h3>2. Get the Container Loaded</h3> <p>The Synology Container Manager GUI will let you import an image in a tar file. That way was easy. But how could I do this from the command line?</p> <p>I learned two things:</p> <ol> <li>The Container Manager GUI is really just running <code>docker</code> under the hood.</li> <li>The <code>docker</code> and <code>docker-compose</code> executables are installed, but only for root or sudo access.</li> </ol> <p>I enabled the Synology’s SSH service, on an alternate port, and made sure my NAS’s deploy user had administrator rights. Then I set up a key pair so I could ssh without a password.</p> <p>After some trial and error, I found that I needed to use Docker’s <code>load</code> command:</p> <pre><code class="language-sh">$ sudo docker load --input /volume1/docker/meals/dwfrank-meals.tar
</code></pre> <p>…and that I had to have the full path to the image.<sup id="fnref:1" role=doc-noteref><a href="#fn:1" class=footnote rel=footnote>1</a></sup></p> <p>The image showed up in Container Manager as expected. Progress!</p> <h3>3. Injecting Values into the Dockerfile</h3> <p>I decided that the most appropriate place to add the <code>RAILS_MASTER_KEY</code> environment variable was when the image is built. It keeps all the environment vars together, after all.</p> <p>So back to the <code>Dockerfile</code> and its env vars section:</p> <pre><code class="language-Docker">ARG MASTER_KEY=""  
  
# Set production environment  
ENV RAILS_ENV="production" \  
    BUNDLE_DEPLOYMENT="1" \  
    BUNDLE_PATH="/usr/local/bundle" \  
    BUNDLE_WITHOUT="development" \  
    RAILS_MASTER_KEY=$MASTER_KEY
</code></pre> <p>I added the empty Docker ARG for the master key, and then pass it in at build time.<sup id="fnref:2" role=doc-noteref><a href="#fn:2" class=footnote rel=footnote>2</a></sup> This meant writing the first rake task that does any of this work so I could read the key from the Rails config directory:</p> <pre><code class="language-ruby">key = File.read("config/master.key")  
system "docker buildx build --build-arg=\"MASTER_KEY=#{key}\" --platform linux/amd64 -t dwfrank/meals ."
</code></pre> <p>I round-tripped the build again, and after running <code>sudo docker load</code>, the <code>RAILS_MASTER_KEY</code> was right there with the rest of the variables.</p> <h3>4. Adding the Database Volume Mount Point</h3> <p>It looked like <code>docker-compose</code> was the right way to add volumes. So I created a <code>docker-compose.yml</code> in my app’s root with the image name, the name for the container when it’s running, and the database mount point:</p> <pre><code class="language-yaml">services:  
  web:  
    image: dwfrank/meals  
    container_name: balboa-meals  
    command: bash -c "rm -f tmp/pids/server.pid &amp;&amp; ./bin/rails server"  
    volumes:  
      - /volume1/docker/meals/db:/rails/db/production
</code></pre> <p>Then I copied this file to the NAS, ssh’d over, and then called <code>docker-compse</code>:</p> <pre><code class="language-bash">$ cp docker-compose.yml /Volumes/docker/meals
$ ssh deploy@192.168.1.100:822
$ # Now on the NAS
$ cd /volume1/docker/meals
$ sudo docker-compose create .
</code></pre> <p>…and I had the container loaded but not running. And all of the environment variables were there as I expected.</p> <h3>5. Connecting the Container to the Web Station</h3> <p>The last step was going to have to be manual for now. In the DSM GUI:<sup id="fnref:3" role=doc-noteref><a href="#fn:3" class=footnote rel=footnote>3</a></sup></p> <ul> <li>Container Manager - run the container</li> <li>Web Station - reconnect the <code>meals.local</code> portal, which won’t have a container associated with it, to the container I just ran.</li> </ul> <p>So let’s stitch this all together!</p> <h3>6. Rake All the Things!</h3> <p>To recap the work so far, I did the following:</p> <ul> <li>Built a <code>production.sqlite3</code> <ul> <li>Moved to a subdirectory under <code>./db</code></li> <li>Fixed <code>./config/database.yml</code></li> </ul> </li> <li>Added a <code>./.dockerignore</code> <ul> <li>Excluded <code>./tmp</code></li> <li>Excluded <code>./db/production/</code></li> </ul> </li> <li>Updated the Rails <code>./Dockerfile</code> <ul> <li>Commented out asset builds</li> <li>Added NAS user and group IDs to the <code>chown</code> commands</li> <li>Added injecting the <code>RAILS_MASTER_KEY</code> during the image build</li> <li>Used this <code>Dockerfile</code> to build the container image from the command line</li> </ul> </li> <li>Added a <code>./docker-compose.yml</code> <ul> <li>Picks the image name</li> <li>Sets a container name</li> <li>Sets the database volume mount point</li> </ul> </li> </ul> <p>The remaining work that needed to be done on the NAS, via <code>sudo</code>, to deploy the app was to load the image, with <code>docker</code>, and then execute <code>docker-compose</code>. Local commands are easy. But what about the <code>sudo</code> commands?</p> <p>Enter <a href="https://github.com/capistrano/sshkit">SSHKit</a>. This is what Capistrano and Kamal use under the hood in order to do their work. And SSHKit <a href="https://github.com/kentaroi/sshkit-sudo">has a Sudo module</a>. So I was able to use all this for the last remote commands.</p> <p>I made two additions to the <code>Gemfile</code> development group:</p> <pre><code class="language-ruby">gem "sshkit"  
gem "sshkit-sudo"
</code></pre> <p>And then these commands are in a Rake task:</p> <pre><code class="language-ruby">require "sshkit"
require "sshkit/dsl"
require "sshkit/sudo"

desc "Loads the built image into Docker on Filgate"  
task :deploy_to_synology do
 include SSHKit::DSL

  pw = "kwijibo" # get your password from a password manager, etc.
  send_password = SSHKit::MappingInteractionHandler.new("Password: " =&gt; pw)

  bin = "/usr/local/bin"
  docker_compose = "#{bin}/docker-compose"
  docker = "#{bin}/docker"

  on "deployuser@192.168.10.124:622" do
    # acutal mounted path for the docker folder
    within "/volume1/docker/meals" do
      sudo "#{docker_compose} down",
        interaction_handler: send_password
      sudo "#{docker} image rm --force dwfrank/meals",
        interaction_handler: send_password
      sudo "#{docker} load --input /volume1/docker/meals/dwfrank-meals.tar",
        interaction_handler: send_password
      sudo "#{docker_compose} create",
        interaction_handler: send_password
    end
  end
end
</code></pre> <p>Of note above:</p> <ul> <li>SSHKit wasn’t loading the <code>PATH</code> as expected, so I used absolute paths to the executables</li> <li>It stops the running container down and then deletes its image</li> <li>Then it uses <code>docker load</code> to add the image to Container Manager/Docker <ul> <li>The assumption is that the image tar is present</li> </ul> </li> <li>Then it uses <code>docker-compose</code> to <em>create</em> the new container from that image</li> </ul> <p>So when you look at the <a href="https://github.com/infews/synology_on_rails">repo</a>, you’ll see these tasks:</p> <ul> <li>Ensure that git is clean and everything is committed.</li> <li>Rebuild the Rails assets in <code>./public</code>.</li> <li>Build the image.</li> <li>Copy the image and <code>docker-compose.yml</code> to the NAS.</li> <li>Do the Docker work on the NAS: <ul> <li>Top the current container</li> <li>Remove its image</li> <li>Load the new image</li> <li>Create the new container</li> </ul> </li> </ul> <p>Phew! And now I’m wondering how I can get the last manual steps into Rake tasks. Stay Tuned!</p> <hr/> <div class=footnotes role=doc-endnotes> <ol> <li id="fn:1" role=doc-endnote> <p>My Synology NAS mounts most of the file system to <code>/volume1</code>. Your mileage will vary and will be different from what you see in the DSM File Station. <a href="#fnref:1" class=reversefootnote role=doc-backlink>&#8617;</a></p> </li> <li id="fn:2" role=doc-endnote> <p>I also went back and uses the same technique for the UserID and GroupID for the <code>chown</code> command. You can see that in the code in the GIST. <a href="#fnref:2" class=reversefootnote role=doc-backlink>&#8617;</a></p> </li> <li id="fn:3" role=doc-endnote> <p>I’m guessing that Web Station sits on top nginx configuration files, but I’ve not found them or the right mix of commands yet. I will update this post, and/or add a Part III, once I figure this out. <a href="#fnref:3" class=reversefootnote role=doc-backlink>&#8617;</a></p> </li> </ol> </div> </section> <hr> <section class='about with_sharing'> <div class=tags> This article is part of the series <a href="/series/rails-docker-nas">Synology on Rails</a> and is tagged with <a href="/tags/web-development">web development</a>, <a href="/tags/ruby">ruby</a>, <a href="/tags/rails">rails</a>, <a href="/tags/software-engineering">software engineering</a>, and <a href="/tags/deployment">deployment</a>. </div> <div class=sharing> <button article='Synology on Rails Part II: Deploying' class=share style='display: none;' type=button> Share <i class='fa-solid fa-arrow-up-right-from-square'></i> </button> </div> </section> </article> </main> <footer class=site> <p class=small>© 2023 Davis W. Frank</p> </footer> <script async='' src='https://www.googletagmanager.com/gtag/js?id=G-SNXCW3490N'></script> <script>
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
gtag('config', 'G-SNXCW3490N');
</script> </body> <script src='/js/share-bb52c367.js'></script> </html>
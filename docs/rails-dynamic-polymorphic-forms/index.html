<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Dynamic Polymorphic Forms in Rails 7 | DWF‚Äôs Journal</title> <link href='/feed.xml' rel=alternate title='Atom Feed' type='application/atom+xml'> <script type='application/ld+json'>
{"@type":"BlogPosting","url":"https://dwf.bigpencil.net/rails-dynamic-polymorphic-forms/","datePublished":"2023-11-15","dateCreated":"2023-11-15","dateModified":"2023-11-15","headline":"Dynamic Polymorphic Forms in Rails 7","abstract":"Relearning Rails modeling, polymorphism, and dynamic forms.","keywords":["ruby","rails","dynamic forms","polymorphism"],"author":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"publisher":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"articleBody":"\nIt was time to move my Meal Planning app from AirTable to a custom application. AirTable‚Äôs pricing for the size of the database wasn‚Äôt awful, but I‚Äôd moved past the free account limits. And there were some features I wanted to add that were hard with the basic AirTable features.\n\nIt‚Äôs been a while, so let‚Äôs write a Rails app!\n\nI exported CSVs from AirTable, ran bundle \u0026amp;\u0026amp; rails new and got to test-driving. Rails 7 and Resource scaffolding just worked as I expected. Recipes and Restaurants came together very quickly.\n\nAs soon as I tried to model a calendar of days, where days could have one or more restaurants and one or more recipes (a key feature of the current solution), things got complex.\n\nI ran into three problems:\n\n\n  Rails and forms with has_many associations\n  But the association is polymorphic\n  But the form really needs to be dynamic in order to add/remove things from the association\n\n\nComplex Forms\n\nI had my Recipe and Restaurant models and full controllers. Now I wanted to add a Day model that has a date as well has has_many :recipes as a starting point.\n\nRails has gotten pretty mature when it comes to the fields_for helper that basically gives you a nested form that includes your association. The Complex Forms section of the Action View Form Helpers Rails Guide talks about People with more than one address. This is great for explaining how form_with and fields_for work together.\n\nTo keep things simple, I only tried to add and edit one Recipe on a Day. It was working great. Now it was time to make the association polymorphic.\n\nPolymorphic has-and-belongs-to-many\n\nI needed to be able to add one recipe or one restaurant. I tried several different modelings of the associations to get a polymorphic has_many to work and couldn‚Äôt get all the tests passing. Then I found this StackOverflow post that was. I needed a separate join table with some has_many through‚Äôs‚Äô.\n\nOf course! I needed something that looked more like:\n\nDay \u0026lt;-\u0026gt; Meal (Course \u0026lt;-\u0026gt; [Recipe | Restaurant])\n\nWhich got me to these models:\n\nclass Day \u0026lt; ApplicationRecord  \n  validates :date, uniqueness: true  \n  validates :date, presence: true  \n  \n  has_many :meals, dependent: :destroy  \nend\n\nclass Meal \u0026lt; ApplicationRecord  \n  belongs_to :day  \n  belongs_to :course, polymorphic: true  \nend\n\nclass Recipe \u0026lt; ApplicationRecord  \n  validates :name, presence: true  \n  \n  has_many :meals, as: :course  \n  has_many :days, through: :meals  \nend\n\nclass Restaurant \u0026lt; ApplicationRecord  \n  validates :name, presence: true  \n  \n  has_many :meals, as: :course  \n  has_many :days, through: :meals  \nend\n\n(Note: I‚Äôm not thrilled with the name of course, but it‚Äôs close enough.)\n\nNow with the form, I could put one Recipe select and one Restaurant select and be able to have one or the other. There were some bugs, sure. But I was creating, updating, and saving Days. Progress!\n\nNext question - how do I get the form properly dynamic, adding as many recipes and restaurants as I wanted?\n\nDynamic Complex Polymorphic Forms\n\nThere‚Äôs a nice caveat at the Rails Guide for forms:\n\n\n  Rather than rendering multiple sets of fields ahead of time you may wish to add them only when a user clicks on an ‚ÄúAdd new address‚Äù button. Rails does not provide any built-in support for this.\n\n\nWhoops. I‚Äôm on my own.\n\nTo recap, I knew that what I wanted was for a Day form to start with no Meals, but then be able to add or delete many Recipes and Restaurants and submit that form at the end to create or update the Day.\n\nTime to learn Turbo and Hotwire.\n\nI found two great pages that helped immensely. First, was Alexis Ch√°vez‚Äôs guide to Turbo \u0026amp; Hotwire. The concepts were clear - it‚Äôs a bit like old RJS, but more formal thanks to how Controllers have evolved. But how do I structure the form?\n\nBack to StackOverflow, and a nicely detailed question Rails 7 Dynamic Nested Forms with hotwire/turbo frames. It models cocktails with ingredients and looked a lot like what I needed.\n\nI had some patterns! Time for some code.\n\nDaysController gets new methods\n\nFirst, a couple of new routes:\n\nresources :days do  \n  get :new_meal, on: :collection, path: \"new_meal/:course_type\"  \n  delete :destroy_meal, on: :collection, path: \"destroy_meal/(:id)\"  \nend\n\nThen in the Day form I added two Turbo links that call the #new_meal method: one to add a Recipe and one to add a Restaurant.\n\n.meals\n  ...\n  = link_to new_meal_days_path(\"Recipe\"), data: { turbo_method: :get } do  \n    %i.fa-regular.fa-square-plus  \n    = \"Add Recipe\"  \n  = link_to new_meal_days_path(\"Restaurant\"), data: { turbo_method: :get } do  \n    %i.fa-regular.fa-square-plus  \n    = \"Add Restaurant\"\n\n\nThen in DaysController:\n\ndef new_meal  \n  helpers.fields model: Day.new do |f| \n    f.fields_for :meals,  \n                 Meal.new,  \n                 child_index: \n                   Process.clock_gettime(Process::CLOCK_REALTIME, :millisecond) do |ff|  \n      render turbo_stream: \n               turbo_stream.append(\"meals\", \n                                   partial: \"meal_fields\", \n                                   locals: {f: ff, klass: params[:course_type] })  \n    end  \n  end\nend  \n\n\nCopying from the ‚ÄúCocktails‚Äù post, this method:\n\n  Creates a form helper that will build the tags for a Day and then one Meal\n  Passes the fields_for form helper (ff) to the view, along with the course_type that came in from the GET\n\n\nAnd then the meals_fields view‚Ä¶\n\n- div_id = \"meal_#{f.index}\"  \n  \n%div{id: div_id}  \n  = f.hidden_field :id  \n  = f.hidden_field :course_type, value: course_type  \n  .course_edits  \n    = f.collection_select :course_id, \n                          course_type.constantize.order(:name), \n                          :id, \n                          :name, \n                          prompt: \"Select a #{course_type}...\"  \n    = link_to destroy_meal_days_path(id: f.object.id, div_id: div_id), \n              data: { turbo_method: :delete } do  \n      %i.fa-regular.fa-square-minus\n\n\nThis builds a div with a unique ID (from the timestamp in the controller method) that renders:\n\n  Hidden fields for the Meal id and course_type\n  A select with that type‚Äôs list (yay, String#constantize!)\n  A link to destroy this section of the form, if the user so chooses\n\n\nAnd that link routes back to DaysController#destory_meal\n\ndef destroy_meal  \n  Meal.find(params[:id]).destroy! if params[:id]  \n  \n  render turbo_stream: turbo_stream.remove(params[:div_id])  \nend\n\nWhich will‚Ä¶\n\n  Find and destroy the Meal if this is a Day#edit and so an id is provided; but ignores it if not\n  Removes this Meal‚Äôs div inside the Day form\n\n\nIt‚Äôs Alive!\n\n\n\nPhew! Thanks, Internet!\n\nLinks\n\n\n  Rails Guide - Active View Form Helpers\n  StackOverflow - Polymorphic Has and Belongs to Many\n  Medium - Hotwire: Supercharged Rails forms with Turbo by Alexis Ch√°vez\n  StackOverflow - Rails 7 Dynamic Nested Forms with hotwire/turbo frames\n\n\n","@context":"https://schema.org"}
</script> <link href='https://cdn.jsdelivr.net/npm/holiday.css@0.11.2' rel=stylesheet> <script crossorigin=anonymous src='https://kit.fontawesome.com/e76ee0328c.js'></script> <link href='/stylesheets/v23-fb3ac88f.css' rel=stylesheet> <link href='/stylesheets/prism-laserwave-b0c76a64.css' rel=stylesheet> <script src='/js/prism-7933fd4a.js'></script> </head> <body> <nav class=menu> <ul> <li> <a class='' href='/'>Home</a> </li> <li> <span>Posts</span> <ul> <li> <a href='/series/the-cd-test'>The CD Test</a> </li> <li> <a href='/series/obsidian'>How I Obsidian</a> </li> <li> <a href='/series/interestings'>Interestings for Iterators</a> </li> <li> <a href='/series/rails-docker-nas'>Synology on Rails</a> </li> <li> <a href='/posts'>All Posts</a> </li> <li> <a href='/all_tags'>All Tags</a> </li> </ul> </li> <li> <a href='/about_me'>About Me</a> </li> </ul> </nav> <main class=''> <picture> <img alt='Colourful food üç±' src='https://images.unsplash.com/photo-1589010588553-46e8e7c21788?crop=entropy&amp;cs=tinysrgb&amp;fit=max&amp;fm=jpg&amp;ixid=M3w0NjkxMjJ8MHwxfGFsbHx8fHx8fHx8fDE3MDAwNjg4Nzh8&amp;ixlib=rb-4.0.3&amp;q=80&amp;w=1080&amp;utm_source=dwfs_journal_big_pencil&amp;utm_medium=referral&amp;utm_campaign=api-credit'> </picture> <article> <h1> Dynamic Polymorphic Forms in Rails 7 </h1> <section class='header with_sharing'> <div class=info> <span class=date>15 November 2023</span> <span class=dash>&#8212;</span> <span class=duration>about a 5 minute read</span> </div> <div class=sharing> <button article='Dynamic Polymorphic Forms in Rails 7' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> <section class=text> <p>It was time to move <a href="/covid-19-inspired-meal-planning/">my Meal Planning app</a> from AirTable to a custom application. AirTable‚Äôs pricing for the size of the database wasn‚Äôt awful, but I‚Äôd moved past the free account limits. And there were some features I wanted to add that were hard with the basic AirTable features.</p> <p>It‚Äôs been a while, so let‚Äôs write a Rails app!</p> <p>I exported CSVs from AirTable, ran <code>bundle &amp;&amp; rails new</code> and got to test-driving. Rails 7 and Resource scaffolding just worked as I expected. <code>Recipes</code> and <code>Restaurants</code> came together very quickly.</p> <p>As soon as I tried to model a calendar of days, where days could have one or more restaurants and one or more recipes (a key feature of the current solution), things got complex.</p> <p>I ran into three problems:</p> <ol> <li>Rails and forms with <code>has_many</code> associations</li> <li>But the association is polymorphic</li> <li>But the form really needs to be dynamic in order to add/remove things from the association</li> </ol> <h2>Complex Forms</h2> <p>I had my <code>Recipe</code> and <code>Restaurant</code> models and full controllers. Now I wanted to add a <code>Day</code> model that has a date as well has <code>has_many :recipes</code> as a starting point.</p> <p>Rails has gotten pretty mature when it comes to the <code>fields_for</code> helper that basically gives you a nested form that includes your association. The <a href="https://guides.rubyonrails.org/form_helpers.html#building-complex-forms">Complex Forms</a> section of the Action View Form Helpers Rails Guide talks about People with more than one address. This is great for explaining how <code>form_with</code> and <code>fields_for</code> work together.</p> <p>To keep things simple, I only tried to add and edit one <code>Recipe</code> on a <code>Day</code>. It was working great. Now it was time to make the association polymorphic.</p> <h2>Polymorphic has-and-belongs-to-many</h2> <p>I needed to be able to add one recipe <em>or</em> one restaurant. I tried several different modelings of the associations to get a polymorphic <code>has_many</code> to work and couldn‚Äôt get all the tests passing. Then I found <a href="https://stackoverflow.com/questions/51564463/polymorphic-has-and-belongs-to-many">this StackOverflow post</a> that was. I needed a separate join table with some <code>has_many through</code>‚Äôs‚Äô.</p> <p>Of course! I needed something that looked more like:</p> <p><code>Day &lt;-&gt; Meal (Course &lt;-&gt; [Recipe | Restaurant])</code></p> <p>Which got me to these models:</p> <pre><code class="language-ruby">class Day &lt; ApplicationRecord  
  validates :date, uniqueness: true  
  validates :date, presence: true  
  
  has_many :meals, dependent: :destroy  
end

class Meal &lt; ApplicationRecord  
  belongs_to :day  
  belongs_to :course, polymorphic: true  
end

class Recipe &lt; ApplicationRecord  
  validates :name, presence: true  
  
  has_many :meals, as: :course  
  has_many :days, through: :meals  
end

class Restaurant &lt; ApplicationRecord  
  validates :name, presence: true  
  
  has_many :meals, as: :course  
  has_many :days, through: :meals  
end
</code></pre> <p>(Note: I‚Äôm not thrilled with the name of <code>course</code>, but it‚Äôs close enough.)</p> <p>Now with the form, I could put one <code>Recipe</code> select and one <code>Restaurant</code> select and be able to have one or the other. There were some bugs, sure. But I was creating, updating, and saving <code>Day</code>s. Progress!</p> <p>Next question - how do I get the form properly dynamic, adding as many recipes and restaurants as I wanted?</p> <h2>Dynamic Complex Polymorphic Forms</h2> <p>There‚Äôs a nice caveat at the Rails Guide for forms:</p> <blockquote> <p>Rather than rendering multiple sets of fields ahead of time you may wish to add them only when a user clicks on an ‚ÄúAdd new address‚Äù button. Rails does not provide any built-in support for this.</p> </blockquote> <p>Whoops. I‚Äôm on my own.</p> <p>To recap, I knew that what I wanted was for a <code>Day</code> form to start with no Meals, but then be able to add or delete many <code>Recipes</code> and <code>Restaurants</code> and submit that form at the end to create or update the <code>Day</code>.</p> <p>Time to learn Turbo and Hotwire.</p> <p>I found two great pages that helped immensely. First, was <a href="https://medium.com/@alexischvez">Alexis Ch√°vez‚Äôs</a> guide to <a href="https://medium.com/@alexischvez/hotwire-supercharged-rails-forms-with-turbo-6de79bb9e374">Turbo &amp; Hotwire</a>. The concepts were clear - it‚Äôs a bit like old RJS, but more formal thanks to how Controllers have evolved. But how do I structure the form?</p> <p>Back to StackOverflow, and a nicely detailed question <a href="https://stackoverflow.com/questions/71713303/rails-7-dynamic-nested-forms-with-hotwire-turbo-frames">Rails 7 Dynamic Nested Forms with hotwire/turbo frames</a>. It models cocktails with ingredients and looked a lot like what I needed.</p> <p>I had some patterns! Time for some code.</p> <h2>DaysController gets new methods</h2> <p>First, a couple of new routes:</p> <pre><code class="language-ruby">resources :days do  
  get :new_meal, on: :collection, path: "new_meal/:course_type"  
  delete :destroy_meal, on: :collection, path: "destroy_meal/(:id)"  
end
</code></pre> <p>Then in the <code>Day</code> form I added two Turbo links that call the <code>#new_meal</code> method: one to add a <code>Recipe</code> and one to add a <code>Restaurant</code>.</p> <pre><code class="language-ruby">.meals
  ...
  = link_to new_meal_days_path("Recipe"), data: { turbo_method: :get } do  
    %i.fa-regular.fa-square-plus  
    = "Add Recipe"  
  = link_to new_meal_days_path("Restaurant"), data: { turbo_method: :get } do  
    %i.fa-regular.fa-square-plus  
    = "Add Restaurant"
</code></pre> <p>Then in <code>DaysController</code>:</p> <pre><code class="language-ruby">def new_meal  
  helpers.fields model: Day.new do |f| 
    f.fields_for :meals,  
                 Meal.new,  
                 child_index: 
                   Process.clock_gettime(Process::CLOCK_REALTIME, :millisecond) do |ff|  
      render turbo_stream: 
               turbo_stream.append("meals", 
                                   partial: "meal_fields", 
                                   locals: {f: ff, klass: params[:course_type] })  
    end  
  end
end  
</code></pre> <p>Copying from the ‚ÄúCocktails‚Äù post, this method:</p> <ul> <li>Creates a form helper that will build the tags for a <code>Day</code> and then one <code>Meal</code></li> <li>Passes the <code>fields_for</code> form helper (<code>ff</code>) to the view, along with the <code>course_type</code> that came in from the <code>GET</code></li> </ul> <p>And then the <code>meals_fields</code> view‚Ä¶</p> <pre><code class="language-ruby">- div_id = "meal_#{f.index}"  
  
%div{id: div_id}  
  = f.hidden_field :id  
  = f.hidden_field :course_type, value: course_type  
  .course_edits  
    = f.collection_select :course_id, 
                          course_type.constantize.order(:name), 
                          :id, 
                          :name, 
                          prompt: "Select a #{course_type}..."  
    = link_to destroy_meal_days_path(id: f.object.id, div_id: div_id), 
              data: { turbo_method: :delete } do  
      %i.fa-regular.fa-square-minus
</code></pre> <p>This builds a <code>div</code> with a unique ID (from the timestamp in the controller method) that renders:</p> <ul> <li>Hidden fields for the <code>Meal</code> <code>id</code> and <code>course_type</code></li> <li>A select with that type‚Äôs list (yay, <code>String#constantize</code>!)</li> <li>A link to destroy this section of the form, if the user so chooses</li> </ul> <p>And that link routes back to <code>DaysController#destory_meal</code></p> <pre><code class="language-ruby">def destroy_meal  
  Meal.find(params[:id]).destroy! if params[:id]  
  
  render turbo_stream: turbo_stream.remove(params[:div_id])  
end
</code></pre> <p>Which will‚Ä¶</p> <ul> <li>Find and destroy the <code>Meal</code> if this is a <code>Day#edit</code> and so an <code>id</code> is provided; but ignores it if not</li> <li>Removes this <code>Meal</code>‚Äôs <code>div</code> inside the <code>Day</code> form</li> </ul> <h2>It‚Äôs Alive!</h2> <p><img src="/images/editing_day-e7952cd8.png" alt="completed form"/></p> <p>Phew! Thanks, Internet!</p> <h2>Links</h2> <ul> <li><a href="https://guides.rubyonrails.org/form_helpers.html#building-complex-forms">Rails Guide - Active View Form Helpers</a></li> <li><a href="https://stackoverflow.com/questions/51564463/polymorphic-has-and-belongs-to-many">StackOverflow - Polymorphic Has and Belongs to Many</a></li> <li><a href="https://medium.com/@alexischvez/hotwire-supercharged-rails-forms-with-turbo-6de79bb9e374">Medium - Hotwire: Supercharged Rails forms with Turbo</a> by <a href="https://medium.com/@alexischvez">Alexis Ch√°vez</a></li> <li><a href="https://stackoverflow.com/questions/71713303/rails-7-dynamic-nested-forms-with-hotwire-turbo-frames">StackOverflow - Rails 7 Dynamic Nested Forms with hotwire/turbo frames</a></li> </ul> </section> <hr> <section class='about with_sharing'> <div class=tags> This article is tagged with <a href="/tags/web-development">web development</a>, <a href="/tags/ruby">ruby</a>, <a href="/tags/rails">rails</a>, and <a href="/tags/forms">forms</a>. </div> <div class=sharing> <button article='Dynamic Polymorphic Forms in Rails 7' class=share style='display:none;' type=button> Share <i class='ios fa-solid fa-arrow-up-from-bracket' style='display:none;'></i> <i class='aos fa-solid fa-share-nodes' style='display:none;'></i> </button> </div> </section> </article> </main> <footer class=site> <p class=small>¬© 2025 Davis W. Frank</p> </footer> <script async='' src='https://www.googletagmanager.com/gtag/js?id=G-SNXCW3490N'></script> <script>
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
gtag('config', 'G-SNXCW3490N');
</script> </body> <script src='/js/share-c97280fa.js'></script> </html>
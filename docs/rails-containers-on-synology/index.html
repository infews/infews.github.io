<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Synology on Rails Part I: Running | DWF’s Journal</title> <link href='/feed.xml' rel=alternate title='Atom Feed' type='application/atom+xml'> <script type='application/ld+json'>
{"@type":"BlogPosting","url":"https://dwf.bigpencil.net/rails-containers-on-synology/","datePublished":"2023-12-12","dateCreated":"2023-12-12","dateModified":"2023-12-13","headline":"Synology on Rails Part I: Running","abstract":"How finally learned containers and got my Rails Meal Planning app up on running on my Synology NAS.","keywords":["web development","ruby","rails","software engineering","deployment","docker","containers","synology","nas"],"author":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"publisher":{"@type":"Person","name":"Davis W. Frank","email":"dwfrank@gmail.com","url":"https://dwf.bigpencil.net/about_me","alumniOf":"University of Georgia","image":"https://dwf.bigpencil.net/images/dwf@2x-b89bef4d.png","sameAs":["https://www.linkedin.com/in/daviswfrank","https://github.com/infews","https://ruby.social/@dwfrank","https://www.threads.net/@dwfrank"]},"articleBody":"\nFollowing my last post, I was ready to deploy an early version of my Meal Planning/Recording Rails app. Given this is a small app, with really only two users, I didn’t feel it necessary to pay to deploy it to the cloud and to do the work needed to secure it for cloud hosting.\n\nI knew that I could run containerized apps on my Synology NAS. So I just needed to figure out howto get Rails and my app containerized and deployed.\n\nWhat I Wanted\n\n\n  Rails app running in a container on the NAS\n  The SQLite file not in the container\n  Access inside my home network\n  Autmoatable deployment\n\n\nWhat I Had\n\n\n  A Rails app using a SQLite database\n  A Mac Mini M2 for development\n  A Synology NAS with an Intel processor running DSM 7.2\n  Me, who despite working at Pivotal on container-based technology, only had a conceptual understanding of all of these pieces working together.\n\n\nWhat I Did\n\nFirst, I needed an image.\n\n1. Install Docker on MacOS\n\nI installed the Homebrew Cask version of Docker\n\n$ brew install --cask docker\n\n\nI ran Docker, keeping the Docker daemon running in the background on MacOS.\n\n2. Getting The Rails 7.1 Dockerfile\n\nRails 7.1 ships with a Dockerfile. I built the app with Rails 7.0, but have since upgraded to 7.1, so I generated a new app and copied these two key files:\n\n\n  ./Dockerfile\n  ./bin/docker-entrypoint\n\n\nI’m using cssbuild to turn my SASS into CSS. I decided to keep Node and Yarn out of the container for size, which means I made this change to the Dockerfile to comment out the asset compilation:\n\n# Precompiling assets for production without requiring secret RAILS_MASTER_KEY \n#RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile\n\n\nI’ll deal with assets later.\n\n3. Building the Image\n\nIt’s possible to build an Intel-targeted container on Apple silicon. Very simple:\n\n$ docker buildx build --platform linux-amd64 -t \u0026lt;tag-name\u0026gt;\n\n\nHowever, the when bundling, Bundler complained that the Gemfile needed to support Intel processors.  This line adds this support:\n\n$ bundle lock --add-platform x86_64-linux\n\n\nThen the image build just worked and was in Docker locally. Then I was able to push the image to Docker Hub in the GUI.\n\n4. Running the Image on Synology DSM\n\nI followed this guide to better understand how containers, and the Container Manager, work on Synology. I applied this knowledge by:\n\n\n  Updated Synology DSM to 7.2+\n  Installed the Container Manager package\n  Installed the Web Station package\n  Imported my image from Docker Hub\n  Ran that image to get a booted container\n\n\nThis almost worked. Everything was good until step 5. The Container Manager had all of the environment variables. Port 3000 was exposed.\n\nI followed the prompts in the UI and made a named Web Station Web Portal - I called it meals.local that pointed to the Container. I also updated my local DNS - I use a Firewalla at home - so that meals.local pointed to my NAS’s IP address.\n\n5. Whoops - RAILS_MASTER_KEY\n\nBut Rails wouldn’t start because I didn’t have the master key. This was a simple setting in the Container Manager app, adding a RAILS_MASTER_KEY environment variable and manually copying the key over from config/master.key.\n\nI saved and restarted the container.\n\n6. Whoops - The Database\n\nNow Rails wouldn’t start because there was no database.  I did the following:\n\n\n  Created and migrated the production database file in db/production/production.sqlite3 on my dev machine\n  Updated config/database.yml:\n\n\nproduction:  \n  \u0026lt;\u0026lt;: *default  \n  database: db/production/production.sqlite3\n\n\n\n  Downloaded a Rails .dockerignore (thanks yizeng!) and added db/production to it\n    \n      This keeps the production SQLite file out of the container\n    \n  \n  Created a directory for my app on the NAS\n    \n      Synology Container Manager makes a directory called /docker, so I made /docker/meals\n    \n  \n  Shared /docker so I could see it on my network, thus able to copy files from my development machine\n  Copied production.sqlite to /docker/meals/db/production.sqlite3\n  Rebuilt the image and uploaded to Docker Hub\n\n\nFrom there I was able to stop and delete the container, then update the image from Docker Hub. Before I started it I had to make a container Settings change in Container Manager:\n\n\n  Map a mount point in Container Manager (Container - Settings - Volume Settings in the GUI) for the container so that /rails/db/production in the container pointed to /docker/meals/db on the NAS.\n\n\nI rebuilt and restarted again.\n\n7. Whoops - Users and File Permissions\n\nRails still wouldn’t start. This time it was because the rails user, which the Dockerfile creates, didn’t exist. Back to Synology DSM.\n\n\n  Created a user named rails in the users group\n  Fount the rails user id and group id - I had to sudo to the NAS for this\n  Updated the Dockerfile’s “useradd” area like this:\n\n\n# Run and own only the runtime files as a non-root user for security  \n# Synology DSM - make a user called 'rails' and save its id (will need to ssh/terminal for this)  \n\nARG UID=132 # sudo and find this  \nARG GID=100 # likely this value, but sudo and set properly  \n\nRUN useradd -m -u $UID -g $GID --create-home --shell /bin/bash rails \u0026amp;\u0026amp; \\  \n    chown -R rails:users db log storage tmp public\n\n# Switch to this user\nUSER rails:users\n\n\nThen I had to do the manual cycle of build image, push image, stop container, delete container, update image, run image, change container settings.\n\nBut the app booted and worked! I could visit https://meals.local and see my app. Victory!\n\nThis was a lot of trial and error. And I was tired of all the manual building, copying, and GUI work.\n\nNext post: automating the deploy.\n\n","@context":"https://schema.org"}
</script> <link href='https://cdn.jsdelivr.net/npm/holiday.css@0.11.2' rel=stylesheet> <script crossorigin=anonymous src='https://kit.fontawesome.com/e76ee0328c.js'></script> <link href='/stylesheets/v23-87c5bb67.css' rel=stylesheet> <link href='/stylesheets/prism-laserwave-b0c76a64.css' rel=stylesheet> <script src='/js/prism-7933fd4a.js'></script> </head> <body> <nav class=menu> <ul> <li> <a class='' href='/'>Home</a> </li> <li> <span>Posts</span> <ul> <li> <a href='/series/the-cd-test'>The CD Test</a> </li> <li> <a href='/series/obsidian'>How I Obsidian</a> </li> <li> <a href='/series/rails-docker-nas'>Synology on Rails</a> </li> <li> <a href='/posts'>All Posts</a> </li> <li> <a href='/all_tags'>All Tags</a> </li> </ul> </li> <li> <a href='/notion'>Notion Templates</a> </li> <li> <a href='/about_me'>About Me</a> </li> </ul> </nav> <main class=''> <article> <h1> Synology on Rails Part I: Running </h1> <section class='header with_sharing'> <div class=info> <span class=date>12 December 2023</span> <span class=dash>&#8212;</span> <span class=duration>about a 5 minute read</span> </div> <div class=sharing> <button article='Synology on Rails Part I: Running' class=share style='display: none;' type=button> Share <i class='fa-solid fa-arrow-up-right-from-square'></i> </button> </div> </section> <section class=text> <p>Following my <a href="/rails-dynamic-polymorphic-forms/">last post</a>, I was ready to deploy an early version of my Meal Planning/Recording Rails app. Given this is a small app, with really only two users, I didn’t feel it necessary to pay to deploy it to the cloud and to do the work needed to secure it for cloud hosting.</p> <p>I knew that I could run containerized apps on my Synology NAS. So I just needed to figure out howto get Rails and my app containerized and deployed.</p> <h2>What I Wanted</h2> <ul> <li>Rails app running in a container on the NAS</li> <li>The SQLite file <em>not</em> in the container</li> <li>Access inside my home network</li> <li>Autmoatable deployment</li> </ul> <h2>What I Had</h2> <ul> <li>A Rails app using a SQLite database</li> <li>A Mac Mini M2 for development</li> <li>A Synology NAS with an Intel processor running DSM 7.2</li> <li>Me, who despite working at Pivotal on container-based technology, only had a conceptual understanding of all of these pieces working together.</li> </ul> <h2>What I Did</h2> <p>First, I needed an image.</p> <h3>1. Install Docker on MacOS</h3> <p>I installed the Homebrew Cask version of Docker</p> <pre><code class="language-bash">$ brew install --cask docker
</code></pre> <p>I ran Docker, keeping the Docker daemon running in the background on MacOS.</p> <h3>2. Getting The Rails 7.1 Dockerfile</h3> <p>Rails 7.1 ships with a Dockerfile. I built the app with Rails 7.0, but have since upgraded to 7.1, so I generated a new app and copied these two key files:</p> <ul> <li><code>./Dockerfile</code></li> <li><code>./bin/docker-entrypoint</code></li> </ul> <p>I’m using <code>cssbuild</code> to turn my SASS into CSS. I decided to keep Node and Yarn out of the container for size, which means I made this change to the Dockerfile to comment out the asset compilation:</p> <pre><code class="language-bash"># Precompiling assets for production without requiring secret RAILS_MASTER_KEY 
#RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile
</code></pre> <p>I’ll deal with assets later.</p> <h3>3. Building the Image</h3> <p>It’s possible to build an Intel-targeted container on Apple silicon. Very simple:</p> <pre><code class="language-bash">$ docker buildx build --platform linux-amd64 -t &lt;tag-name&gt;
</code></pre> <p>However, the when bundling, Bundler complained that the Gemfile needed to support Intel processors. This line adds this support:</p> <pre><code class="language-bash">$ bundle lock --add-platform x86_64-linux
</code></pre> <p>Then the image build just worked and was in Docker locally. Then I was able to push the image to Docker Hub in the GUI.</p> <h3>4. Running the Image on Synology DSM</h3> <p>I followed <a href="https://www.youtube.com/watch?v=aUFpdjfDI6c">this guide</a> to better understand how containers, and the Container Manager, work on Synology. I applied this knowledge by:</p> <ol> <li>Updated Synology DSM to 7.2+</li> <li>Installed the Container Manager package</li> <li>Installed the Web Station package</li> <li>Imported my image from Docker Hub</li> <li>Ran that image to get a booted container</li> </ol> <p>This <em>almost</em> worked. Everything was good until step 5. The Container Manager had all of the environment variables. Port 3000 was exposed.</p> <p>I followed the prompts in the UI and made a named Web Station Web Portal - I called it <code>meals.local</code> that pointed to the Container. I also updated my local DNS - I use a <a href="https://firewalla.com">Firewalla</a> at home - so that <code>meals.local</code> pointed to my NAS’s IP address.</p> <h3>5. Whoops - RAILS_MASTER_KEY</h3> <p>But Rails wouldn’t start because I didn’t have the master key. This was a simple setting in the Container Manager app, adding a <code>RAILS_MASTER_KEY</code> environment variable and manually copying the key over from <code>config/master.key</code>.</p> <p>I saved and restarted the container.</p> <h3>6. Whoops - The Database</h3> <p>Now Rails wouldn’t start because there was no database. I did the following:</p> <ol> <li>Created and migrated the production database file in <code>db/production/production.sqlite3</code> on my dev machine</li> <li>Updated <code>config/database.yml</code>:</li> </ol> <pre><code class="language-yaml">production:  
  &lt;&lt;: *default  
  database: db/production/production.sqlite3
</code></pre> <ol> <li>Downloaded a Rails <code>.dockerignore</code> (thanks <a href="https://gist.github.com/yizeng/eeeb48d6823801061791cc5581f7e1fc">yizeng</a>!) and added <code>db/production</code> to it <ul> <li>This keeps the production SQLite file out of the container</li> </ul> </li> <li>Created a directory for my app on the NAS <ul> <li>Synology Container Manager makes a directory called <code>/docker</code>, so I made <code>/docker/meals</code></li> </ul> </li> <li>Shared <code>/docker</code> so I could see it on my network, thus able to copy files from my development machine</li> <li>Copied <code>production.sqlite</code> to <code>/docker/meals/db/production.sqlite3</code></li> <li>Rebuilt the image and uploaded to Docker Hub</li> </ol> <p>From there I was able to stop and delete the container, then update the image from Docker Hub. Before I started it I had to make a container Settings change in Container Manager:</p> <ol> <li>Map a mount point in Container Manager (Container - Settings - Volume Settings in the GUI) for the container so that <code>/rails/db/production</code> in the container pointed to <code>/docker/meals/db</code> on the NAS.</li> </ol> <p>I rebuilt and restarted again.</p> <h3>7. Whoops - Users and File Permissions</h3> <p>Rails still wouldn’t start. This time it was because the <code>rails</code> user, which the Dockerfile creates, didn’t exist. Back to Synology DSM.</p> <ol> <li>Created a user named <code>rails</code> in the <code>users</code> group</li> <li>Fount the <code>rails</code> user id and group id - I had to <code>sudo</code> to the NAS for this</li> <li>Updated the Dockerfile’s “<code>useradd</code>” area like this:</li> </ol> <pre><code class="language-docker"># Run and own only the runtime files as a non-root user for security  
# Synology DSM - make a user called 'rails' and save its id (will need to ssh/terminal for this)  

ARG UID=132 # sudo and find this  
ARG GID=100 # likely this value, but sudo and set properly  

RUN useradd -m -u $UID -g $GID --create-home --shell /bin/bash rails &amp;&amp; \  
    chown -R rails:users db log storage tmp public

# Switch to this user
USER rails:users
</code></pre> <p>Then I had to do the manual cycle of build image, push image, stop container, delete container, update image, run image, change container settings.</p> <p>But the app booted and worked! I could visit <code>https://meals.local</code> and see my app. Victory!</p> <p>This was a lot of trial and error. And I was tired of all the manual building, copying, and GUI work.</p> <p>Next post: automating the deploy.</p> </section> <hr> <section class='about with_sharing'> <div class=tags> This article is part of the series <a href="/series/rails-docker-nas">Synology on Rails</a> and is tagged with <a href="/tags/web-development">web development</a>, <a href="/tags/ruby">ruby</a>, <a href="/tags/rails">rails</a>, <a href="/tags/software-engineering">software engineering</a>, and <a href="/tags/deployment">deployment</a>. </div> <div class=sharing> <button article='Synology on Rails Part I: Running' class=share style='display: none;' type=button> Share <i class='fa-solid fa-arrow-up-right-from-square'></i> </button> </div> </section> </article> </main> <footer class=site> <p class=small>© 2023 Davis W. Frank</p> </footer> <script async='' src='https://www.googletagmanager.com/gtag/js?id=G-SNXCW3490N'></script> <script>
window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
gtag('config', 'G-SNXCW3490N');
</script> </body> <script src='/js/share-aa52ba7b.js'></script> </html>